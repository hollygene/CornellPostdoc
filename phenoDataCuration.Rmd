---
title: "phenotypic_data_organization"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



```{r load_pheno_data, include=FALSE}
phen2017 <- read.csv(file="/Users/hcm59/Box/Holly/Analyses/Analyses/Ecoli/2017-ECOL-MIC-Vet-LIRN.csv",header=TRUE,na.strings = c("", "NA"))
phen2018 <- read.csv(file="/Users/hcm59/Box/Holly/Analyses/Analyses/Ecoli/2018-ECOL-MIC-Vet-LIRN.csv",header=TRUE,na.strings = c("", "NA"))
phen2019 <- read.csv(file="/Users/hcm59/Box/Holly/Analyses/Analyses/Ecoli/2019-ECOL-MIC-Vet-LIRN.csv",header=TRUE,na.strings = c("", "NA"))

```



```{r organize,include=TRUE}
## annotations file that contains IDs that match phenotype dataset and those that match SNP dataset 
anno <- read.csv("/Users/hcm59/Box/Holly/Analyses/Analyses/Ecoli/ecoli_dog_200contigs_w_panaroo_tag.csv",header=TRUE)

# want strain (ID used in phenotypic data) and assembly (ID used in SNP data)
header <- colnames(anno)
header.want <- c(grep("Strain",header),grep("Assembly",header),grep("Isolation.Source",header))
anno.want <- anno[header.want]
View(anno.want)
anno.want2 <- substr(anno.want$Assembly, 1, regexpr("\\.", anno.want$Assembly)-1)
anno.want2

# merge phenotypic data with annotations to get IDs and assembly in same file 
library(dplyr)
colnames(phen2017)
phen2017.anno <- inner_join(anno.want, phen2017, by=c("Strain" = "sample.ID."),keep=TRUE)
View(phen2017.anno)
library(dplyr)    
phen2017.fin <- filter(phen2017.anno, specific.host == "Canis lupus familiaris")

phen2018.anno <- inner_join(anno.want, phen2018, by=c("Strain" = "sample.ID."),keep=TRUE)
View(phen2018.anno)

phen2018.fin <- filter(phen2018.anno, specific.host == "Canis lupus familiaris")

phen2019.anno <- inner_join(anno.want, phen2019, by=c("Strain" = "sample.ID."),keep=TRUE)
View(phen2019.anno)
phen2019.fin <- filter(phen2019.anno, specific.host == "Canis lupus familiaris")

phenAll <- dplyr::bind_rows(phen2017.fin,phen2018.fin,phen2019.fin)
phenAll$Assembly
test <- dplyr::inner_join(phenAll,anno.want,by="Assembly")
test$Assembly <- substr(test$Assembly, 1, regexpr("\\.", test$Assembly)-1)
test$Assembly
phenAllFinal <- test
# read in file of dog samples wanted 
# dogsWanted <- read.table("/Users/hcm59/Box/Github/CornellPostdoc/phenDogs_samples_wanted.txt",header=FALSE)
# colnames(dogsWanted) <- c("Assembly")
# join with phenotype data
# dogs601 <- dplyr::inner_join(phenAll,dogsWanted,by="Assembly")
# write.csv(phenAllFinal,"/Users/hcm59/Box/Holly/Analyses/Analyses/Ecoli/phenotypesDogs171819.csv")
dogs601 <- read.csv("/Users/hcm59/Box/Holly/Analyses/Analyses/Ecoli/phenotypesDogs171819.csv")
```

```{r phen_subset,include=FALSE}
# first import back in the data you exported before
# Phen <- read.table("/Users/hcm59/Box/Github/CornellPostdoc/phenAll.txt",header=TRUE)
Phen <- dogs601
library(dplyr)
library(reshape2)
# phen.Melt <- melt(Phen, id.vars=c("Assembly"),variable.name = "antibiotic", value.name = "INT",na.rm = TRUE)


# find all instances of "SUSC" and replace with 0
# install.packages("tidyverse")
library(tidyverse)
phen.sub.0 <- Phen %>% mutate_if(is.atomic,funs(str_replace(., "SUSC", "0")))
phen.sub.0
# worked! # now do that to RESIST and convert NOINTP
phen.sub.01 <- phen.sub.0 %>%  mutate_if(is.atomic,funs(str_replace(., "RESIST", "1")))
phen.sub.01.1 <- phen.sub.01 %>%  mutate_if(is.atomic,funs(str_replace(., "NOINTP", "")))
phen.sub.01.2 <- phen.sub.01.1 %>%  mutate_if(is.atomic,funs(str_replace(., "INTER", "")))
# View(phen.sub.01.2)
phen.sub.01.3 <- phen.sub.01.2 %>% mutate_all(na_if,"")


rownames(phen.sub.01.3) <- dogs601$Assembly
rownames(phen.sub.01.3)
View(phen.sub.01.3)
phen.sub.01.4 <- phen.sub.01.3[,c(1,3:104)]
# View(phen.sub.01.4)
str(phen.sub.01.4)

#export whole pheno file 
# write.csv(phen.sub.01.4, file="/Users/hcm59/Box/Holly/Analyses/Analyses/Ecoli/pheno601Dogs_cleaned.csv")

#subset phenotype file into isolation source
isolationSource601Dogs <- as.data.frame(cbind(rownames(phen.sub.01.4),phen.sub.01.4$Isolation.Source,phen.sub.01.4$Isolation.Source))
colnames(isolationSource601Dogs) <- c("Sample","Source","SourceClean")
# export as txt file for use in iTOL 
# write.table(isolationSource601Dogs,file="/Users/hcm59/Box/Holly/Analyses/Analyses/Ecoli/isolationSourcePheno601Dogs.txt",quote=F, row.names = F)


```

```{r try DataEditR, include=FALSE}
# This seems like an appropriate time to try using this DataEditR package
# library(devtools)
# install_github("DillonHammill/DataEditR")
# devtools::install_github("DillonHammill/rhandsontable")

library(DataEditR)



isolationSourceCleaned <- data_edit(isolationSource601Dogs,save_as = "isolationSource_cleaned.txt",code="isolationSourceEdit.R")
levels(as.factor(isolationSourceClean$SourceClean))
isolationSourceCleaned <- data_edit(isolationSourceCleaned,save_as = "isolationSource_cleaned.txt")
isolationSourceClean <- isolationSourceCleaned %>% dplyr::select(Sample,SourceClean)
write.table(isolationSourceClean,file="/Users/hcm59/Box/Holly/Analyses/Analyses/Ecoli/isolationSourceCleaned.txt",quote=F, row.names = F)


isoClean <- read.table("/Users/hcm59/Box/Holly/Analyses/Analyses/Ecoli/isolationSourceCleaned.txt",header=TRUE)
library(tidyverse)
isoBinary <- isoClean %>% mutate_if(is.atomic,funs(str_replace(., "urine", "1")))
isoBinary2 <- data_edit(isoBinary,save_as = "isolationSource_binary.txt",code="isolationSourceEdit2.R")
isoBinarycheck <- cbind(isoBinary,isoBinary2$SourceClean)
write.table(isoBinary2,file="/Users/hcm59/Box/Holly/Analyses/Analyses/Ecoli/isolationSourceBinary.txt",quote=F,row.names=F)
p <- ggplot(isolationSourceClean, aes(x=SourceClean),color="turquoise") + 
  geom_bar() + theme_classic() + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1,size=12)) 
p

summary(isolationSourceClean$SourceClean)

```


```{r phenoForiTOL, include=TRUE}
# Data for iTOL needs to be coded numerically instead of with strings 
isolationSourceClean











```

```{r pheno_curation, include=FALSE}
# combine cefalexin and cephalexin columns into one 
# did this in excel
# read back in .csv 
phenCefComb <- read.csv("/Users/hcm59/Box/Holly/Analyses/Analyses/Ecoli/phenotypesDogs171819_Cef_Combined.csv")

library(tidyverse)
phenCefComb.0 <- phenCefComb %>% mutate_if(is.atomic,funs(str_replace(., "SUSC", "0")))
phenCefComb.0
# worked! # now do that to RESIST and convert NOINTP
phenCefComb.01 <- phenCefComb.0%>%  mutate_if(is.atomic,funs(str_replace(., "RESIST", "1")))
phenCefComb.01.1 <- phenCefComb.01 %>%  mutate_if(is.atomic,funs(str_replace(., "NOINTP", "")))
phenCefComb.01.2 <- phenCefComb.01.1 %>%  mutate_if(is.atomic,funs(str_replace(., "INTER", "")))
# View(phen.sub.01.2)
phenCefComb.01.3 <- phenCefComb.01.2 %>% mutate_all(na_if,"")


rownames(phenCefComb.01.3) <- dogs601$Assembly
rownames(phenCefComb.01.3)
View(phenCefComb.01.3)
phenCefComb.01.4 <- phenCefComb.01.3[,c(2:336)]
phenCefCombHeader <- colnames(phenCefComb.01.4)
phenCefCombHeader
headr.want <- c(grep("Assembly",phenCefCombHeader),grep("Strain",phenCefCombHeader),grep("Isolation.Source",phenCefCombHeader),grep("Assembly",phenCefCombHeader),grep("sample.ID.",phenCefCombHeader),grep("INT",phenCefCombHeader),grep("specific.host",phenCefCombHeader))
headr.want 
phenCefComb.01.4.short <- phenCefComb.01.4[headr.want]
# table(phenCefComb.01.4.short$Strain.x == phenCefComb.01.4.short$Strain.y)
write.csv(phenCefComb.01.4.short,file="/Users/hcm59/Box/Holly/Analyses/Analyses/Ecoli/phenoCefComb.csv") 
# View(phen.sub.01.4)
str(phen.sub.01.4)

abxOccurences <- read.table(file="/Users/hcm59/Box/Holly/Analyses/Analyses/Ecoli/abxResistOccurences.txt")

library(ggplot2)
setwd("/Users/hcm59/Box/Holly/Analyses/Analyses/Ecoli/")
pdf("/Users/hcm59/Box/Holly/Analyses/Analyses/Ecoli/dist_resist_phenos.pdf")
qplot(abxOccurences$V2,binwidth=1, geom="histogram"  ,  main = "", 
      xlab = "# Antibiotics Resistant To", ylab="# Isolates", 
      fill=I("turquoise"), 
      col=I("darkturquoise")) + geom_vline(xintercept=2)
dev.off()


```


## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
